<!DOCTYPE html>
<html>
<head><style>
.left-of-center-image {
    position: absolute;
    top: 20px;
    left: 40%;
    transform: translateX(-50%);
    max-width: 150px;
    z-index: 1000;
}
</style>
<title>Live GPS Tracker v1.9 - NSW Topo + World Imagery</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; z-index: 0; }
    /* (CSS unchanged, omitted for brevity) */
</style>
</head>
<body><img alt="SCU Crest" class="left-of-center-image" src="https://raw.githubusercontent.com/AnthonyMacks/gps_tracker/main/templates/scucrest.png"/>
<div id="map"></div>
<!-- (HTML structure unchanged, omitted for brevity) -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
<script>
    // (JS code before unchanged)

    function addDataPoint(point, isLatest = false) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);
      
      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        console.warn('Invalid coordinates:', point);
        return;
      }

      const color = deviceColors[point.device_id] || "#7F8C8D";
      console.log(`Adding point for ${point.device_id}: (${lat}, ${lon}), isLatest: ${isLatest}`);

      if (isLatest) {
        // (latest marker code unchanged)
      } else {
        const isFirstPoint = !allMarkers[point.device_id] || allMarkers[point.device_id].history.length === 0;
        
        if (isFirstPoint) {
          const crestIcon = L.icon({
            iconUrl: "https://raw.githubusercontent.com/AnthonyMacks/gps_tracker/main/templates/scucrest.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          });

          const crestMarker = L.marker([lat, lon], { 
            icon: crestIcon,
            interactive: true
          });

          const popupContent = `
            <strong>Device ID:</strong> ${point.device_id} (START)<br>
            <strong>Latitude:</strong> ${lat.toFixed(6)}<br>
            <strong>Longitude:</strong> ${lon.toFixed(6)}<br>
            <strong>Timestamp:</strong> ${point.timestamp}
          `;
          crestMarker.bindPopup(popupContent);

          if (!allMarkers[point.device_id]) allMarkers[point.device_id] = { current: null, history: [] };
          allMarkers[point.device_id].history.push(crestMarker);
          
          if (deviceVisibility[point.device_id] !== false) {
            crestMarker.addTo(map);
          }
          
          totalPoints++;
        } else {
          // (history pin code unchanged)
        }
      }
    }

    // (rest of JS unchanged)
</script>
</body>
</html>
