<!DOCTYPE html>

<html>
<head><style>
.lower-right-image {
    position: absolute;
    bottom: 20px;
    right: 20px;
    max-width: 120px;
    z-index: 1000;
}

</style>
<title>Live GPS Tracker v1.9 - NSW Topo + World Imagery</title>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; z-index: 0; }

    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      max-width: 340px;
      max-height: 70%;
      overflow-y: auto;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 13px;
      color: #2C3E50;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    #info2 {
      position: absolute;
      top: 10px;
      right: 370px;
      max-width: 340px;
      max-height: 70%;
      overflow-y: auto;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 13px;
      color: #2C3E50;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    #toggle-button, #toggle-button2 {
      background-color: #0078D7;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      width: 100%;
    }
    
    #toggle-button:hover, #toggle-button2:hover {
      background-color: #005A9E;
    }

    #opacity-control {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    #opacity-control label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    #opacity-control input[type="range"] {
      width: 150px;
      margin-right: 10px;
    }

    .row-active { background-color: #D5F5E3; }
    .row-warm   { background-color: #FCF3CF; }
    .row-stale  { background-color: #FADBD8; }

    .row-low-sats {
      background-color: #F5B7B1 !important;
      animation: blink 1s step-start infinite;
    }

    @keyframes blink {
      50% { background-color: #FADBD8; }
    }

    .device-label {
      background: transparent;
      color: black;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      font-size: 11px;
    }

    .arrow-icon {
      font-weight: bold;
      font-size: 8px;
    }

    footer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      color: #666;
      font-family: sans-serif;
      background-color: rgba(255,255,255,0.6);
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 1001;
    }

    @keyframes pulse {
      0%   { background-color: #D5F5E3; }
      50%  { background-color: #ABEBC6; }
      100% { background-color: #D5F5E3; }
    }

    .row-active {
      animation: pulse 2s infinite;
    }

    #debug {
      position: absolute;
      bottom: 20%;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 11px;
      max-width: 300px;
      z-index: 1001;
      transition: all 0.3s ease;
      cursor: pointer;
      height: auto;
      min-height: 20px;
    }

    #debug.collapsed {
      height: 25px;
      padding: 5px 10px;
      overflow: hidden;
    }

    #debug .debug-content {
      transition: all 0.3s ease;
      opacity: 1;
      max-height: 200px;
    }

    #debug.collapsed .debug-content {
      opacity: 0;
      max-height: 0;
      margin-top: -5px;
    }

    #debug .debug-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 11px;
    }

    #debug.collapsed .debug-title {
      margin-bottom: 0;
      font-size: 10px;
    }

    /* Animated dots on polyline */
    .animated-polyline {
      stroke-dasharray: 1, 14;
      stroke-linecap: round;
      animation: moveDots 4s linear infinite;
    }

    .trail-arrow {
      z-index: 1000;
      animation: moveArrowAlongTrail 2s linear infinite;
    }

    @keyframes moveArrowAlongTrail {
      0% {
        transform: translateX(-4px) translateY(-4px) rotate(var(--arrow-bearing));
        opacity: 0.7;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translateX(4px) translateY(4px) rotate(var(--arrow-bearing));
        opacity: 0.7;
      }
    }

    @keyframes moveDots {
      0% {
        stroke-dashoffset: 15;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes moveArrowAlongPath {
      0% {
        transform: translateX(-7px) translateY(-7px);
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translateX(7px) translateY(7px);
        opacity: 0.6;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #333;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #e6f3ff;
    }

    .hidden {
      display: none;
    }

    .row-number {
      background-color: #e9ecef;
      font-weight: bold;
    }

    /* Mobile responsive styles - auto resize panels */
    @media (max-width: 768px) {
      #info {
        position: absolute;
        top: 10px;
        right: 10px;
        left: auto;
        max-width: none;
        width: 45vw;
        max-height: 40vh;
        font-size: 11px;
        padding: 6px;
      }

      #info2 {
        position: absolute;
        top: 10px;
        right: calc(45vw + 20px);
        left: auto;
        max-width: none;
        width: 45vw;
        max-height: 40vh;
        font-size: 11px;
        padding: 6px;
      }

      #info strong, #info2 strong {
        font-size: 12px;
      }

      table {
        font-size: 10px;
      }

      th, td {
        padding: 4px 2px;
      }

      #toggle-button, #toggle-button2 {
        font-size: 12px;
        padding: 6px 12px;
      }

      #opacity-control {
        bottom: 60px;
        left: 10px;
        font-size: 10px;
        padding: 6px;
      }

      #debug {
        bottom: 120px;
        left: 10px;
        font-size: 9px;
        padding: 6px;
        max-width: 200px;
      }

      #debug.collapsed {
        height: 22px;
        padding: 4px 6px;
      }

      #debug .debug-title {
        font-size: 9px;
      }

      #debug.collapsed .debug-title {
        font-size: 8px;
      }

      footer {
        bottom: 10px;
        left: 10px;
        font-size: 10px;
        padding: 2px 4px;
      }
    }

    /* Portrait phone adjustments */
    @media (max-width: 480px) and (orientation: portrait) {
      #info {
        width: 90vw;
        max-height: 30vh;
        font-size: 10px;
        right: 5vw;
      }

      #info2 {
        top: calc(30vh + 60px);
        right: 5vw;
        width: 90vw;
        max-height: 30vh;
        font-size: 10px;
      }

      table {
        font-size: 9px;
      }

      th, td {
        padding: 3px 1px;
      }

      #toggle-button, #toggle-button2 {
        font-size: 11px;
        padding: 5px 10px;
      }

      #opacity-control {
        bottom: 60px;
        left: 10px;
        font-size: 9px;
        padding: 4px;
      }

      #debug {
        bottom: 110px;
        left: 10px;
        font-size: 8px;
        padding: 4px;
        max-width: 150px;
      }

      #debug.collapsed {
        height: 18px;
        padding: 3px 4px;
      }

      #debug .debug-title {
        font-size: 8px;
      }

      #debug.collapsed .debug-title {
        font-size: 7px;
      }

      footer {
        font-size: 9px;
      }
    }

    /* Landscape phone adjustments */
    @media (max-width: 768px) and (orientation: landscape) {
      #info {
        position: absolute;
        top: 10px;
        right: 10px;
        left: auto;
        width: 40vw;
        max-width: 40vw;
        max-height: 80vh;
      }

      #info2 {
        position: absolute;
        top: 10px;
        right: calc(40vw + 20px);
        left: auto;
        width: 40vw;
        max-width: 40vw;
        max-height: 80vh;
      }

      #opacity-control {
        bottom: 10px;
        left: 10px;
        font-size: 10px;
      }

      #debug {
        bottom: 60px;
        left: 10px;
        font-size: 9px;
        max-width: 180px;
      }

      #debug.collapsed {
        height: 20px;
        padding: 4px 6px;
      }

      #debug .debug-title {
        font-size: 9px;
      }

      #debug.collapsed .debug-title {
        font-size: 8px;
      }
    }
    
  </style>
</head>
<body><img alt="SCU Crest" class="lower-right-image" src="https://raw.githubusercontent.com/AnthonyMacks/gps_tracker/main/templates/scucrest.png"/>
<div id="map"></div>
<div id="info">
<strong>üì° GPS MacksTrack Data (I-XV)</strong>
<button id="toggle-button" onclick="toggleTable()">Hide Table</button>
<table id="device-table">
<thead>
<tr>
<th>ID</th>
<th>Lat</th>
<th>Lon</th>
<th>Count</th>
<th>Sats</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="info2">
<strong>üì° GPS MacksTrack Data (XVI-XXVII)</strong>
<button id="toggle-button2" onclick="toggleTable2()">Hide Table</button>
<table id="device-table2">
<thead>
<tr>
<th>ID</th>
<th>Lat</th>
<th>Lon</th>
<th>Count</th>
<th>Sats</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="opacity-control">
<label for="opacity-slider">Base Layer Opacity:</label>
<input id="opacity-slider" max="1" min="0.1" step="0.1" type="range" value="1"/>
<span id="opacity-value">100%</span>
</div>
<div id="debug" class="collapsed">
<div class="debug-title">Debug Info</div>
<div class="debug-content">
    Connected: <span id="socket-status">‚ùå</span><br/>
    Total Devices: <span id="device-count">0</span><br/>
    Total Points: <span id="point-count">0</span><br/>
    Last Update: <span id="last-update">never</span><br/>
    Current Zoom: <span id="current-zoom">13</span>
</div>
</div>
<footer>
    üöÄ Last Render Build: <span id="build-time">loading...</span>
</footer>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
<script>
    // Grid reference conversion function for Australian coordinates
    function latLonToMGRS(lat, lon) {
      try {
        console.log('Converting coordinates:', lat, lon);
        
        // Determine UTM zone for Australia
        const zone = Math.floor((lon + 180) / 6) + 1;
        
        // Basic UTM conversion parameters
        const a = 6378137; // WGS84 major axis
        const e = 0.0818191908; // WGS84 eccentricity
        const k0 = 0.9996; // UTM scale factor
        
        const lonRad = (lon * Math.PI) / 180;
        const latRad = (lat * Math.PI) / 180;
        
        const lonOrigin = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;
        
        const N = a / Math.sqrt(1 - e * e * Math.sin(latRad) * Math.sin(latRad));
        const T = Math.tan(latRad) * Math.tan(latRad);
        const C = (e * e / (1 - e * e)) * Math.cos(latRad) * Math.cos(latRad);
        const A = Math.cos(latRad) * (lonRad - lonOrigin);
        
        const M = a * ((1 - e * e / 4 - 3 * Math.pow(e, 4) / 64) * latRad
          - (3 * e * e / 8 + 3 * Math.pow(e, 4) / 32) * Math.sin(2 * latRad)
          + (15 * Math.pow(e, 4) / 256) * Math.sin(4 * latRad));
        
        let easting = k0 * N * (A + (1 - T + C) * Math.pow(A, 3) / 6
          + (5 - 18 * T + T * T + 72 * C - 58 * (e * e / (1 - e * e))) * Math.pow(A, 5) / 120) + 500000;
        
        let northing = k0 * (M + N * Math.tan(latRad) * (Math.pow(A, 2) / 2
          + (5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4) / 24
          + (61 - 58 * T + T * T + 600 * C - 330 * (e * e / (1 - e * e))) * Math.pow(A, 6) / 720));
        
        // For southern hemisphere
        if (lat < 0) northing += 10000000;
        
        // Convert to 4-digit grid coordinates
        const eastingGrid = Math.floor((easting % 100000) / 10).toString().padStart(4, '0');
        const northingGrid = Math.floor((northing % 100000) / 10).toString().padStart(4, '0');
        
        // Return just the 8-figure grid reference without zone prefix
        const result = `${eastingGrid} ${northingGrid}`;
        console.log('Grid reference result:', result);
        return result;
        
      } catch (error) {
        console.error('Grid conversion error:', error);
        return `Grid: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
      }
    }

    // Toggle table visibility functions
    function toggleTable() {
      const table = document.getElementById("device-table");
      const button = document.getElementById("toggle-button");
      
      if (table.style.display === "none") {
        table.style.display = "table";
        button.textContent = "Hide Table";
      } else {
        table.style.display = "none";
        button.textContent = "Show Table";
      }
    }

    function toggleTable2() {
      const table = document.getElementById("device-table2");
      const button = document.getElementById("toggle-button2");
      
      if (table.style.display === "none") {
        table.style.display = "table";
        button.textContent = "Hide Table";
      } else {
        table.style.display = "none";
        button.textContent = "Show Table";
      }
    }

    // Initialize map with higher max zoom
    const map = L.map("map", {
      maxZoom: 22
    }).setView([-32.7686, 151.1790], 14);
    
    // Base layers with increased maxZoom and maxNativeZoom
    const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 22,
      maxNativeZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    });

    const nswTopoLayer = L.esri.tiledMapLayer({
      url: 'https://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Topo_Map/MapServer',
      attribution: '¬© NSW Spatial Services',
      maxZoom: 22,
      maxNativeZoom: 16,
      opacity: 1
    });

    const nswImageryLayer = L.esri.tiledMapLayer({
      url: 'https://maps.six.nsw.gov.au/arcgis/rest/services/public/NSW_Imagery/MapServer',
      attribution: '¬© NSW Spatial Services',
      maxZoom: 22,
      maxNativeZoom: 18,
      opacity: 1
    });

    // Google Satellite imagery
    const worldImageryGoogle = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: '¬© Google',
      maxZoom: 22,
      maxNativeZoom: 20
    });

    // Add NSW Topo as default
    nswTopoLayer.addTo(map);
    let currentBaseLayer = nswTopoLayer;

    // Layer control with only the required maps
    const baseLayers = {
      "NSW Topographic": nswTopoLayer,
      "NSW Imagery": nswImageryLayer,
      "World Imagery (Google)": worldImageryGoogle,
      "OpenStreetMap": osmLayer
    };

    const layerControl = L.control.layers(baseLayers, null, {
      position: 'topleft'
    }).addTo(map);

    // Add zoom level display
    const currentZoomSpan = document.getElementById('current-zoom');
    map.on('zoomend', function() {
      currentZoomSpan.textContent = map.getZoom();
    });

    // Opacity control
    const opacitySlider = document.getElementById('opacity-slider');
    const opacityValue = document.getElementById('opacity-value');

    opacitySlider.addEventListener('input', function() {
      const opacity = parseFloat(this.value);
      currentBaseLayer.setOpacity(opacity);
      opacityValue.textContent = Math.round(opacity * 100) + '%';
    });

    // Update current base layer when user switches
    map.on('baselayerchange', function(e) {
      currentBaseLayer = e.layer;
      const opacity = parseFloat(opacitySlider.value);
      currentBaseLayer.setOpacity(opacity);
    });

    // Device colors - expanded for 27 devices with vibrant colors for better visibility
    const deviceColors = {
      '1': '#E74C3C', '2': '#3498DB', '3': '#2ECC71', '4': '#F39C12', '5': '#9B59B6',
      '6': '#1ABC9C', '7': '#E67E22', '8': '#34495E', '9': '#E91E63', '10': '#FF5722',
      '11': '#795548', '12': '#607D8B', '13': '#FF9800', '14': '#4CAF50', '15': '#673AB7',
      'I': '#E74C3C', 'II': '#3498DB', 'III': '#2ECC71', 'IV': '#F39C12', 'V': '#9B59B6',
      'VI': '#1ABC9C', 'VII': '#E67E22', 'VIII': '#34495E', 'IX': '#E91E63', 'X': '#FF5722',
      'XI': '#795548', 'XII': '#607D8B', 'XIII': '#FF9800', 'XIV': '#4CAF50', 'XV': '#673AB7',
      'XVI': '#FF1744', 'XVII': '#448AFF', 'XVIII': '#00E676', 'XIX': '#FFC107', 'XX': '#AB47BC',
      'XXI': '#26C6DA', 'XXII': '#FF6F00', 'XXIII': '#546E7A', 'XXIV': '#EC407A', 'XXV': '#8BC34A',
      'XXVI': '#5E35B1', 'XXVII': '#FF5252'
    };

    // Initialize socket connection
    const socket = io({ 
      transports: ['websocket'],
      timeout: 5000,
      forceNew: true
    });
    
    // Debug elements
    const socketStatus = document.getElementById('socket-status');
    const deviceCount = document.getElementById('device-count');
    const pointCount = document.getElementById('point-count');
    const lastUpdate = document.getElementById('last-update');
    
    let totalPoints = 0;

    // Socket connection handlers
    socket.on('connect', () => {
      console.log('‚úÖ Socket connected');
      socketStatus.textContent = '‚úÖ';
      socketStatus.style.color = '#2ECC71';
    });

    socket.on('disconnect', () => {
      console.log('‚ùå Socket disconnected');
      socketStatus.textContent = '‚ùå';
      socketStatus.style.color = '#E74C3C';
    });

    socket.on('connect_error', (error) => {
      console.error('Socket connection error:', error);
      socketStatus.textContent = '‚ö†Ô∏è';
      socketStatus.style.color = '#F39C12';
    });

    const gpsTrails = {};
    const packetCounts = {};
    const latestPackets = {};
    const allPointsBounds = L.latLngBounds();
    const allMarkers = {};
    const trailLayers = {};
    const deviceVisibility = {};
    let selectedDevice = null;
    let hasInitialData = false;

    function toggleDeviceVisibility(deviceId) {
      if (selectedDevice === deviceId) {
        selectedDevice = null;
        showAllDevices();
      } else {
        selectedDevice = deviceId;
        hideAllDevicesExcept(deviceId);
      }
    }

    function showAllDevices() {
      Object.keys(allMarkers).forEach(deviceId => {
        deviceVisibility[deviceId] = true;
        showDeviceMarkers(deviceId);
      });
    }

    function hideAllDevicesExcept(keepDeviceId) {
      Object.keys(allMarkers).forEach(deviceId => {
        if (deviceId === keepDeviceId) {
          deviceVisibility[deviceId] = true;
          showDeviceMarkers(deviceId);
        } else {
          deviceVisibility[deviceId] = false;
          hideDeviceMarkers(deviceId);
        }
      });
    }

    function showDeviceMarkers(deviceId) {
      if (allMarkers[deviceId] && allMarkers[deviceId].current) {
        allMarkers[deviceId].current.circle.addTo(map);
        allMarkers[deviceId].current.label.addTo(map);
      }
      
      if (allMarkers[deviceId] && allMarkers[deviceId].history) {
        allMarkers[deviceId].history.forEach(marker => {
          marker.addTo(map);
        });
      }
      
      if (trailLayers[deviceId]) {
        trailLayers[deviceId].forEach(layer => {
          layer.addTo(map);
        });
      }
    }

    function hideDeviceMarkers(deviceId) {
      if (allMarkers[deviceId] && allMarkers[deviceId].current) {
        map.removeLayer(allMarkers[deviceId].current.circle);
        map.removeLayer(allMarkers[deviceId].current.label);
      }
      
      if (allMarkers[deviceId] && allMarkers[deviceId].history) {
        allMarkers[deviceId].history.forEach(marker => {
          map.removeLayer(marker);
        });
      }
      
      if (trailLayers[deviceId]) {
        trailLayers[deviceId].forEach(layer => {
          map.removeLayer(layer);
        });
      }
    }

    function addDataPoint(point, isLatest = false) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);
      
      // Validate coordinates
      if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        console.warn('Invalid coordinates:', point);
        return;
      }

      const color = deviceColors[point.device_id] || "#7F8C8D";
      const mgrsGrid = latLonToMGRS(lat, lon);
      console.log(`Adding point for ${point.device_id}: (${lat}, ${lon}), Grid: ${mgrsGrid}, isLatest: ${isLatest}`);

      if (isLatest) {
        const circle = L.circleMarker([lat, lon], {
          radius: 10,
          color: color,
          fillColor: color,
          fillOpacity: 0.7,
          weight: 3
        });

        const popupContent = `
          <strong>Device ID:</strong> ${point.device_id}<br>
          <strong>Grid Reference:</strong> ${mgrsGrid}<br>
          <strong>Timestamp:</strong> ${point.timestamp}<br>
          <strong>Satellites:</strong> ${point.sats || 'N/A'}
        `;
        circle.bindPopup(popupContent);

        const label = L.divIcon({
          html: `<div style="color: ${color}; font-weight: bold; text-shadow: 1px 1px 2px white;">${point.device_id}</div>`,
          className: 'device-label',
          iconSize: [20, 20]
        });

        const labelMarker = L.marker([lat, lon], { icon: label, interactive: false });
        
        if (!allMarkers[point.device_id]) allMarkers[point.device_id] = { current: null, history: [] };
        
        if (allMarkers[point.device_id].current) {
          map.removeLayer(allMarkers[point.device_id].current.circle);
          map.removeLayer(allMarkers[point.device_id].current.label);
        }
        
        allMarkers[point.device_id].current = { circle, label: labelMarker };
        
        // Add to map if device is visible
        if (deviceVisibility[point.device_id] !== false) {
          circle.addTo(map);
          labelMarker.addTo(map);
        }
        
        totalPoints++;
        
      } else {
        const isFirstPoint = !allMarkers[point.device_id] || allMarkers[point.device_id].history.length === 0;
        
        if (isFirstPoint) {
          const crestIcon = L.icon({
            iconUrl: "https://raw.githubusercontent.com
