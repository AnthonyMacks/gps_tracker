<!DOCTYPE html>
<html>
<head>
  <title>Live GPS Tracker v2.0</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; z-index: 0; }

    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      max-width: 340px;
      max-height: 70%;
      overflow-y: auto;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 13px;
      color: #2C3E50;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    .row-active { 
      background-color: #D5F5E3;
      animation: pulse-green 2s infinite;
    }
    
    .row-warm { 
      background-color: #FCF3CF;
      animation: pulse-yellow 2s infinite;
    }
    
    .row-stale { 
      background-color: #FADBD8;
      animation: pulse-red 2s infinite;
    }

    .row-low-sats {
      background-color: #F5B7B1 !important;
      animation: blink-red 1s step-start infinite;
    }

    @keyframes pulse-green {
      0%   { background-color: #D5F5E3; }
      50%  { background-color: #ABEBC6; }
      100% { background-color: #D5F5E3; }
    }

    @keyframes pulse-yellow {
      0%   { background-color: #FCF3CF; }
      50%  { background-color: #F7DC6F; }
      100% { background-color: #FCF3CF; }
    }

    @keyframes pulse-red {
      0%   { background-color: #FADBD8; }
      50%  { background-color: #F1948A; }
      100% { background-color: #FADBD8; }
    }

    @keyframes blink-red {
      0%   { background-color: #F5B7B1; }
      50%  { background-color: #E74C3C; }
      100% { background-color: #F5B7B1; }
    }

    .device-label {
      background: transparent;
      color: #154360;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      font-size: 11px;
    }

    .arrow-icon {
      font-weight: bold;
      font-size: 20px;
    }

    footer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      color: #666;
      font-family: sans-serif;
      background-color: rgba(255,255,255,0.6);
      padding: 4px 8px;
      border-radius: 6px;
      z-index: 1001;
    }

    #device-table {
      width: 100%;
      border-collapse: collapse;
    }

    #device-table th, #device-table td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    #device-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    #device-table tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <strong>üì° Latest GPS Data</strong>
    <table id="device-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Lat</th>
          <th>Lon</th>
          <th>Age</th>
          <th>Count</th>
          <th>Sats</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <footer>
    üöÄ Last Render Build: <span id="build-time">loading...</span>
  </footer>
  
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-33.87, 151.21], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    const socket = io({ transports: ['websocket'] });
    const gpsTrails = {};
    const packetCounts = {};
    const latestPackets = {};
    const allPointsBounds = L.latLngBounds();
    const deviceLayers = {}; // Store layers for each device to enable clearing

    const deviceColors = {
      "I": "#E74C3C",    // red
      "II": "#2ECC71",   // green
      "III": "#3498DB",  // blue
      "IV": "#F1C40F"    // yellow
    };

    function clearDeviceLayers(device_id) {
      if (deviceLayers[device_id]) {
        deviceLayers[device_id].forEach(layer => map.removeLayer(layer));
        deviceLayers[device_id] = [];
      }
    }

    function addLabeledCircle(point) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);
      const color = deviceColors[point.device_id] || "#7F8C8D";

      const circle = L.circleMarker([lat, lon], {
        radius: 12,
        color: color,
        fillColor: color,
        fillOpacity: 0.9,
        weight: 2
      }).addTo(map);

      const popupContent = `
        <strong>Device ID:</strong> ${point.device_id}<br>
        <strong>Latitude:</strong> ${lat.toFixed(6)}<br>
        <strong>Longitude:</strong> ${lon.toFixed(6)}<br>
        <strong>Timestamp:</strong> ${point.timestamp}<br>
        <strong>Satellites:</strong> ${point.sats || "N/A"}
      `;
      circle.bindPopup(popupContent);

      const label = L.divIcon({
        html: `<div>${point.device_id}</div>`,
        className: 'device-label',
        iconSize: [24, 24]
      });

      const labelMarker = L.marker([lat, lon], { icon: label, interactive: false }).addTo(map);

      // Store layers for this device
      if (!deviceLayers[point.device_id]) deviceLayers[point.device_id] = [];
      deviceLayers[point.device_id].push(circle, labelMarker);
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const lat1Rad = lat1 * Math.PI / 180;
      const lat2Rad = lat2 * Math.PI / 180;
      
      const y = Math.sin(dLon) * Math.cos(lat2Rad);
      const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
      
      return Math.atan2(y, x) * 180 / Math.PI;
    }

    function addDirectionalArrow(lat1, lon1, lat2, lon2, device_id) {
      const bearing = calculateBearing(lat1, lon1, lat2, lon2);
      const color = deviceColors[device_id] || "#7F8C8D";
      
      // Place arrow at 70% along the segment
      const arrowLat = lat1 + (lat2 - lat1) * 0.7;
      const arrowLon = lon1 + (lon2 - lon1) * 0.7;
      
      const arrowSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20">
          <polygon points="0,-8 4,3 0,1 -4,3" fill="${color}" stroke="white" stroke-width="1" transform="rotate(${bearing})"/>
        </svg>
      `;

      const arrowIcon = L.divIcon({
        html: arrowSvg,
        className: 'arrow-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      const arrowMarker = L.marker([arrowLat, arrowLon], { icon: arrowIcon, interactive: false }).addTo(map);
      
      if (!deviceLayers[device_id]) deviceLayers[device_id] = [];
      deviceLayers[device_id].push(arrowMarker);
    }

    function drawTrailWithArrows(device_id) {
      const trail = gpsTrails[device_id];
      if (!trail || trail.length < 2) return;
      
      const color = deviceColors[device_id] || "#7F8C8D";

      // Draw the polyline
      const polyline = L.polyline(trail, {
        color: color,
        weight: 3,
        opacity: 0.7
      }).addTo(map);

      if (!deviceLayers[device_id]) deviceLayers[device_id] = [];
      deviceLayers[device_id].push(polyline);

      // Add directional arrows every few segments
      const arrowInterval = Math.max(1, Math.floor(trail.length / 5)); // Show ~5 arrows max
      
      for (let i = arrowInterval; i < trail.length; i += arrowInterval) {
        const prevPoint = trail[i - 1];
        const currPoint = trail[i];
        
        addDirectionalArrow(
          prevPoint[0], prevPoint[1],
          currPoint[0], currPoint[1],
          device_id
        );
      }

      // Always add arrow on the most recent segment
      if (trail.length >= 2) {
        const secondLast = trail[trail.length - 2];
        const last = trail[trail.length - 1];
        addDirectionalArrow(
          secondLast[0], secondLast[1],
          last[0], last[1],
          device_id
        );
      }
    }

    function getAgeLabel(ts) {
      const pingTime = new Date(ts);
      const now = new Date();
      const diff = Math.floor((now - pingTime) / 1000);
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      return `${Math.floor(diff / 3600)}h ago`;
    }

    function getRowClass(ts, sats) {
      const pingTime = new Date(ts);
      const now = new Date();
      const diff = (now - pingTime) / 1000;

      if (sats !== undefined && sats < 4) return "row-low-sats";

      if (diff <= 180) return "row-active";      // Green - fresh data
      if (diff <= 360) return "row-warm";       // Yellow - getting old
      return "row-stale";                       // Red - stale data
    }

    function updateTable() {
      const tbody = document.querySelector("#device-table tbody");
      tbody.innerHTML = "";

      const sortedIDs = Object.keys(latestPackets).sort((a, b) => {
        return a.localeCompare(b, 'en', { sensitivity: 'base', numeric: true });
      });

      for (const id of sortedIDs) {
        const packet = latestPackets[id];
        const count = packetCounts[id] || 0;
        const ageLabel = getAgeLabel(packet.timestamp);
        const row = document.createElement("tr");
        row.className = getRowClass(packet.timestamp, packet.sats);
        row.innerHTML = `
          <td>${id}</td>
          <td>${parseFloat(packet.latitude).toFixed(6)}</td>
          <td>${parseFloat(packet.longitude).toFixed(6)}</td>
          <td>${ageLabel}</td>
          <td>${count}</td>
          <td>${packet.sats ?? "‚Äî"}</td>
        `;
        row.addEventListener("click", () => {
          map.setView([parseFloat(packet.latitude), parseFloat(packet.longitude)], 16, { animate: true });
        });
        tbody.appendChild(row);
      }
    }

    socket.on("gps_update", (data) => {
      const { latitude, longitude, device_id } = data;
      if (!latitude || !longitude || !device_id) return;

      const lat = parseFloat(latitude);
      const lon = parseFloat(longitude);

      // Clear previous layers for this device
      clearDeviceLayers(device_id);

      // Add new point
      addLabeledCircle(data);
      allPointsBounds.extend([lat, lon]);
      
      // Update trail
      if (!gpsTrails[device_id]) gpsTrails[device_id] = [];
      gpsTrails[device_id].push([lat, lon]);
      if (gpsTrails[device_id].length > 100) gpsTrails[device_id].shift();

      // Redraw trail with arrows
      drawTrailWithArrows(device_id);
      
      // Update bounds and fit map
      map.fitBounds(allPointsBounds, { padding: [20, 20] });
      
      // Update counters and table
      packetCounts[device_id] = (packetCounts[device_id] || 0) + 1;
      latestPackets[device_id] = data;
      updateTable();

      console.log(`üìç ${device_id} ‚Üí (${lat}, ${lon}) [${data.sats || 'N/A'} sats]`);
    });

    // Refresh age and row color every 5 seconds
    setInterval(updateTable, 5000);
    
    document.getElementById("build-time").textContent =
      new Date().toLocaleString("en-AU", {
        timeZone: "Australia/Sydney",
        hour12: false,
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
  </script>
</body>
</html>
