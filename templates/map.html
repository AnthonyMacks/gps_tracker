<!DOCTYPE html>
<html>
<head>
  <title>Live GPS Tracker v1.5</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 13px;
      color: #2C3E50;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .device-label {
      background: transparent;
      color: #154360;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      font-size: 11px;
    }
    .arrow-icon {
      color: #2874A6;
      font-weight: bold;
      font-size: 20px;
    }
    footer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      color: #666;
      font-family: sans-serif;
      background-color: rgba(255,255,255,0.6);
      padding: 4px 8px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <strong>üì° Device Status</strong><br>
    ID: <span id="device-id">‚Äî</span><br>
    Lat: <span id="latitude">‚Äî</span><br>
    Lon: <span id="longitude">‚Äî</span><br>
    Time: <span id="timestamp">‚Äî</span><br>
    Packets: <span id="packet-count">0</span>
  </div>
  <footer>
    üöÄ Last Render Build: <span id="build-time">loading...</span>
  </footer>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-33.87, 151.21], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    const socket = io({ transports: ['websocket'] });
    const gpsTrails = {};
    const packetCounts = {};

    function addLabeledCircle(point) {
      const lat = parseFloat(point.latitude);
      const lon = parseFloat(point.longitude);

      const circle = L.circleMarker([lat, lon], {
        radius: 12,
        color: '#2E86C1',
        fillColor: '#AED6F1',
        fillOpacity: 0.9,
        weight: 2
      }).addTo(map);

      // üìã Add popup on click
      const popupContent = `
        <strong>Device ID:</strong> ${point.device_id}<br>
        <strong>Latitude:</strong> ${lat.toFixed(6)}<br>
        <strong>Longitude:</strong> ${lon.toFixed(6)}<br>
        <strong>Timestamp:</strong> ${point.timestamp}
      `;
      circle.bindPopup(popupContent);

      // üî§ Add label marker
      const label = L.divIcon({
        html: `<div>${point.device_id}</div>`,
        className: 'device-label',
        iconSize: [24, 24]
      });

      L.marker([lat, lon], { icon: label, interactive: false }).addTo(map);
    }

    function drawTrail(device_id) {
      const trail = gpsTrails[device_id];
      if (trail.length < 2) return;

      L.polyline(trail, {
        color: '#1ABC9C',
        weight: 3,
        opacity: 0.7
      }).addTo(map);
    }

    function addArrow(p1, p2) {
      const latMid = (p1[0] + p2[0]) / 2;
      const lonMid = (p1[1] + p2[1]) / 2;

      const angleRad = Math.atan2(p2[1] - p1[1], p2[0] - p1[0]);
      const angleDeg = angleRad * (180 / Math.PI);

      const arrowIcon = L.divIcon({
        html: `<div style="transform: rotate(${angleDeg}deg);">‚û§</div>`,
        className: 'arrow-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      L.marker([latMid, lonMid], { icon: arrowIcon, interactive: false }).addTo(map);
    }

    function updateInfoPanel(data) {
      document.getElementById("device-id").textContent = data.device_id;
      document.getElementById("latitude").textContent = data.latitude;
      document.getElementById("longitude").textContent = data.longitude;
      document.getElementById("timestamp").textContent = data.timestamp;

      const count = packetCounts[data.device_id] || 0;
      document.getElementById("packet-count").textContent = count;
    }

    socket.on("gps_update", (data) => {
      const { latitude, longitude, device_id } = data;
      if (!latitude || !longitude || !device_id) return;

      const lat = parseFloat(latitude);
      const lon = parseFloat(longitude);

      addLabeledCircle(data);

      if (!gpsTrails[device_id]) {
        gpsTrails[device_id] = [];
        map.setView([lat, lon], 16);
      }
      map.panTo([lat, lon]);

      gpsTrails[device_id].push([lat, lon]);
      if (gpsTrails[device_id].length > 100) gpsTrails[device_id].shift();

      drawTrail(device_id);

      if (gpsTrails[device_id].length >= 2) {
        const trail = gpsTrails[device_id];
        const p1 = trail[trail.length - 2];
        const p2 = trail[trail.length - 1];
        addArrow(p1, p2);
      }

      packetCounts[device_id] = (packetCounts[device_id] || 0) + 1;
      updateInfoPanel(data);

      console.log(`üìç ${device_id} ‚Üí (${lat}, ${lon})`);
    });

    document.getElementById("build-time").textContent =
      new Date().toLocaleString("en-AU", {
        timeZone: "Australia/Sydney",
        hour12: false,
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
  </script>
</body>
</html>
